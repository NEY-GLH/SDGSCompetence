{% extends "base.html" %}
{% block content %}
<div class="page-header">
    <h1>Add A Competency</h1>
</div>

<div class="row">

    <div class="col-md-12">
        <div class="well bs-component">
            <form action="{{ url_for('competence.add_competence') }}" method="POST" class="form-horizontal">
                <fieldset>
                    <legend>Basic Details</legend>

                    <div class="form-group">
                        {{ form.title.label(class_="col-lg-2 control-label") }}
                        <div class="col-lg-10">
                            {{ form.title(class_="form-control") }}
                        </div>
                    </div>


                    <div class="form-group">
                        {{ form.scope.label(class_="col-lg-2 control-label") }}
                        <div class="col-lg-10">
                            {{ form.scope(class_="form-control") }}
                        </div>
                    </div>

                    <div class="form-group">
                        {{ form.competency_type.label(class_="col-lg-2 control-label") }}
                        <div class="col-lg-10">
                                {{ form.competency_type(class_="form-control") }}
                        </div>
                    </div>


                    <div class="form-group">
                        {{ form.validity_period.label(class_="col-lg-2 control-label") }}
                        <div class="col-lg-10">
                            <div class="input-group">
                                {{ form.validity_period(class_="form-control") }}<span class="input-group-btn">
                                 <button class="btn btn-default" type="button" disabled>Months</button>
                                 </span></div>
                        </div>
                    </div>



                    <div class="form-group">
                        {{ form.add_document.label(class_="col-lg-2 control-label") }}
                        <div class="col-lg-10">
                            <div class="input-group">
                                {{ form.add_document(class_="form-control") }}

                                <span class="input-group-btn"><button class="btn btn-primary" id="submit_document"
                                                                      type="button">Attach</button></span>

                            </div>
                            <span class="help-block" id="add_document_text">Please enter a Q-Pulse Document ID</span><div id="invalid_qpulse"></div>
                        </div>
                    </div>

                    <div class="alert alert-danger" role="alert" id="qpulse_error" hidden >This is not a valid QPulse Document! Please try again.</div>
                    <div class="form-group">
                        <div class="col-lg-2"></div>
                        <div class="col-lg-10">
                            <div id="selected_docs"></div>
                        </div>
                    </div>

                    <input type="text" id="doc_list" name="doc_list" hidden>

                    <div class="form-group">
                        <div class="col-lg-10 col-lg-offset-2">
                            {{ form.submit(class_="btn btn-primary") }}

                        </div>

                    </div>


                </fieldset>
            </form>
        </div>
    </div>
</div>
<div id="document_list"></div>


<script>
    //this function does autocomplete for existing documents in the database
    $(function () {
        $.ajax({
            url: '{{ url_for("competence.document_autocomplete") }}'
        }).done(function (data) {
            $('#add_document').autocomplete({
                source: data.json_list,
                minLength: 2
            });
        });
    });
    //This function checks whether the input is a valid Qpulse doc number and adds it to a list if correct, list items are displayed underneath if succesfully added
    $('#submit_document').click(function () {

        $('#qpulse_error').hide()

        previous_value = $('#doc_list').val()
        if (previous_value == "") {
            sep = ''
        } else {
            sep = ','
        }

        var url = "{{ url_for('competence.get_doc_name') }}";
        var doc_id=$('#add_document').val()
        console.log(doc_id);
        console.log(url);

        var dict = {'doc_id':doc_id};
        var data = JSON.stringify(dict);
        console.log(data);

        $.ajax({
                        type: "POST",
                        url: url,
                        data: data,
                        dataType: "json",
                        contentType: "application/json",
                        success: function (response) {
                            console.log(response)

                            if(response.match(/This is not a valid QPulse Document/i))
                            {
                                $('#qpulse_error').show()


                            }
                            else
                            {

                                $('#doc_list').val(previous_value + sep + $('#add_document').val() )
                                $('#selected_docs').append('<a href="#" class="btn btn-success remove" id="remove_document" doc_number="' + $('#add_document').val() + '">' + $('#add_document').val() + ': '+ response +' <span class="glyphicon glyphicon-remove"></span> </a> ')
                                $('#add_document').val('')
                            }
                        },
                        error: function (xhr, status, error) {
                            $('#trace').append("<p>" + error + "</p>");
                            $('#ajaxModal').modal('show');
                            return false;
                        }
                    });

    });

    //this function allows deletion of items from the document list so they can'r be added to the database
    $(document).on("click", '.remove' ,function(){
        console.log("HELLO");
        var docs = $('#doc_list').val().split(',');
        console.log(docs);
        docs.splice( $.inArray($(this).attr('doc_number'), docs),1  );
        console.log(docs);
        $('#doc_list').val(docs.join());
        $(this).remove();
    });

</script>

{% endblock %}