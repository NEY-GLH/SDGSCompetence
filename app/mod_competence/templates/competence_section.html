{% extends "base.html" %}
{% block content %}


    <div class="page-header">
        <h1>Add Competency Sections:</h1>
    </div>

    <div class="row">

        <div class="col-md-12">
            <form action="{{ url_for('competence.add_sections') }}?c_id={{ c_id }}" method="POST"
                  class="form-horizontal">
                <h2>Permanent Sections</h2>
                {% for section in result %}
                    <div class="well bs-component">
                        <ul class="list-unstyled list-inline">
                            <li>
                                <legend>{{ section }}</legend>
                            </li>
                            <li class="pull-right">
                                <div>
                                    <label class="checkbox" for="required">Section Required?&nbsp;&nbsp;
                                    <input id="required" class="" type="checkbox" data-toggle="toggle" data-on="Yes" data-off="No" data-size="mini" data-onstyle="success" data-offstyle="danger" data-id="{{ result[section]['id'] }}" checked></label>
                                </div>
                            </li>
                        </ul>
                        <div class="form-group">
                            <div class="col-md-2"><label> Relevant {{ section }}</label></div>
                            <div class="col-lg-10">

                                    <select class="form-control" name="{{ result[section]['id'] }}_subsections"
                                            id="{{ result[section]['id'] }}_subsections" multiple>
                                        {% for subsections in result[section]['subsections'] %}
                                            {% for subsection in subsections %}
                                                <option value="{{ subsection.id }}">{{ subsection.item }}</option>


                                            {% endfor %}
                                        {% endfor %}
                                    </select>
                                    </div>
                                    </div>
                                    <div class="form-group">
                                        {{ form.add_h_and_s.label(class_="col-lg-2 control-label") }}
                                        <div class="col-lg-10">
                                            <div class="input-group">
                                                {{ form.add_h_and_s(class_="form-control new_item_"+result[section]['id']) }}
                                                <span class="input-group-btn"><button class="btn btn-primary"
                                                                                      type="button"
                                                                                      id="update_{{ result[section]['id'] }}">Update</button></span>
                                            </div>
                                            <span class="help-block">Please enter a new item</span>
                                        </div>
                                    </div>
                                    </div>

                                    <script>

                                        $("#update_{{ result[section]['id'] }}").click(function (e) {
                                            console.log("hello1")
                                            var s_id = {{ result[section]['id'] }};
                                            var item = $(".new_item_{{ result[section]['id'] }}").val()

                                            console.log(s_id);
                                            console.log("hello2");
                                            console.log(item);
                                            console.log("hello3");

                                            var url = "{{ url_for('competence.add_constant_subsection') }}";
                                            var dict = {'s_id': s_id, 'item': item};
                                            var data = JSON.stringify(dict);
                                            console.log(data);

                                            $.ajax({
                                                type: "POST",
                                                url: url,
                                                data: data,
                                                dataType: "json",
                                                contentType: "application/json",
                                                success: function (response) {
                                                    var o = new Option(item, response);
                                                    // $(o).html(item);
                                                    $("#{{ result[section]['id'] }}_subsections").append(o);


                                                },
                                                error: function (xhr, status, error) {
                                                    $('#trace').append("<p>" + error + "</p>");
                                                    $('#ajaxModal').modal('show');
                                                    return false;
                                                }
                                            });


//                     var o = new Option("option text", "value");
//                     $("{{ result[section]['id'] }}_{{ section }}_subsections").append(item);
                                        });


                                    </script>



                {% endfor %}

                <h2>Custom Sections</h2>
                <div class="well bs-component">
                    <div class="form-group">
                        {{ form.choose_section.label(class_="col-lg-2 control-label") }}
                        <div class="col-lg-4">
                            <div class="input-group">
                                {{ form.choose_section(class_="form-control") }}
                                <span class="input-group-btn"><button class="btn btn-primary" id="add_section"
                                                                      type="button">Add</button></span>
                            </div>
                        </div>
                    </div>
                </div>
                <div id="section_list"></div>


                <script>

                    $(document).on('click', '#add_section', function () {
                        var section = $('#choose_section option:selected');
                        var text = $(section).text();
                        var val = $(section).val();
                        var c_id = {{ c_id }};
                        console.log(c_id);

                        var url = "{{ url_for('competence.get_section') }}";
                        var dict = {'text': text, 'val': val, 'c_id': c_id};
                        var data = JSON.stringify(dict);

                        $.ajax({
                            type: "POST",
                            url: url,
                            data: data,
                            dataType: "json",
                            contentType: "application/json",
                            success: function (response) {
                                console.log(response);

                                $('#section_list').append(response);
                            },
                            error: function (xhr, status, error) {
                                $('#trace').append("<p>" + error + "</p>");
                                $('#ajaxModal').modal('show');
                                return false;
                            }
                        });
                    });

                    $(document).on('change', '#required', function(e){
                        console.log($(e.target));
                        console.log($(e.target).attr('data-id'));
                        console.log($(e.target).prop('checked'));
                        var required = $(e.target);
                        var section_id = $(required).attr('data-id');
                        if ($(required).prop('checked')){
                            $('#' + section_id + '_subsections').removeAttr('disabled');
                            $('#update_' + section_id).removeAttr('disabled');

                        }
                        else{
                            $('#' + section_id + '_subsections').attr('disabled', 'disabled');
                            $('#update_' + section_id).attr('disabled', 'disabled');
                        }
                    });

                    $(document).on('click', '#submit', function(){

                    });

                </script>


                <div class="form-group">
                    <div class="col-lg-10 col-lg-offset-2">
                        {{ form.submit(class_="btn btn-primary") }}
                    </div>
                </div>


            </form>
        </div>
    </div>

{% endblock %}